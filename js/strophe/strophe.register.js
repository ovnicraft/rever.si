Strophe.addConnectionPlugin("register",{_connection:null,init:function(d){this._connection=d;var b=0;Object.keys(Strophe.Status).forEach(function(e){b=Math.max(b,Strophe.Status[e])});Strophe.addNamespace("REGISTER","jabber:iq:register");Strophe.Status.REGISTERING=b+1;Strophe.Status.REGIFAIL=b+2;Strophe.Status.REGISTER=b+3;Strophe.Status.SUBMITTING=b+4;Strophe.Status.SBMTFAIL=b+5;Strophe.Status.REGISTERED=b+6;if(d.disco){d.disco.addFeature(Strophe.NS.REGISTER)}var a=this,c=d.reset;d.reset=function(){c();a.instructions="";a.fields={};a.authentication={};a.registered=false;a.enabled=null}},connect:function(c,f,e,d){var b=this._connection;this.instructions="";this.fields={};this.authentication={};this.registered=false;this.enabled=false;b.connect_callback=f;b.connected=false;b.authenticated=false;b.disconnecting=false;b.errors=0;b.domain=c||b.domain;b.wait=e||b.wait;b.hold=d||b.hold;var a=b._buildBody().attrs({to:b.domain,"xml:lang":"en",wait:b.wait,hold:b.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":Strophe.NS.BOSH});b._changeConnectStatus(Strophe.Status.CONNECTING,null);b._requests.push(new Strophe.Request(a.tree(),b._onRequestStateChange.bind(b,this._register_cb.bind(this)),a.tree().getAttribute("rid")));b._throttledRequestHandler()},_register_cb:function(m){var k=this._connection;Strophe.info("_register_cb was called");k.connected=true;var b=m.getResponse();if(!b){return}if(k.xmlInput!==Strophe.Connection.prototype.xmlInput){k.xmlInput(b)}if(k.rawInput!==Strophe.Connection.prototype.rawInput){k.rawInput(Strophe.serialize(b))}var d=b.getAttribute("type");var l,f;if(d!==null&&d=="terminate"){l=b.getAttribute("condition");f=b.getElementsByTagName("conflict");if(l!==null){if(l=="remote-stream-error"&&f.length>0){l="conflict"}k._changeConnectStatus(Strophe.Status.CONNFAIL,l)}else{k._changeConnectStatus(Strophe.Status.CONNFAIL,"unknown")}return}if(!k.sid){k.sid=b.getAttribute("sid")}if(!k.stream_id){k.stream_id=b.getAttribute("authid")}var c=b.getAttribute("requests");if(c){k.window=parseInt(c,10)}var a=b.getAttribute("hold");if(a){k.hold=parseInt(a,10)}var g=b.getAttribute("wait");if(g){k.wait=parseInt(g,10)}var n,o;n=b.getElementsByTagName("register");o=b.getElementsByTagName("mechanism");if(n.length===0&&o.length===0){var h=k._buildBody();k._requests.push(new Strophe.Request(h.tree(),k._onRequestStateChange.bind(k,this._register_cb.bind(this)),h.tree().getAttribute("rid")));k._throttledRequestHandler();return}var e,j;for(e=0;e<o.length;e++){j=Strophe.getText(o[e]);if(j=="DIGEST-MD5"){this.authentication.sasl_digest_md5=true}else{if(j=="PLAIN"){this.authentication.sasl_plain=true}else{if(j=="ANONYMOUS"){this.authentication.sasl_anonymous=true}}}}if(n.length===0){k._changeConnectStatus(Strophe.Status.REGIFAIL,null);return}else{this.enabled=true}k._changeConnectStatus(Strophe.Status.REGISTERING,null);k._addSysHandler(this._get_register_cb.bind(this),null,"iq",null,null);k.send($iq({type:"get"}).c("query",{xmlns:Strophe.NS.REGISTER}).tree())},_get_register_cb:function(e){var a,c,d,b=this._connection;c=e.getElementsByTagName("query");if(c.length!==1){b._changeConnectStatus(Strophe.Status.REGIFAIL,"unknown");return false}c=c[0];for(a=0;a<c.childNodes.length;a++){d=c.childNodes[a];if(d.tagName.toLowerCase()==="instructions"){this.instructions=Strophe.getText(d);continue}else{if(d.tagName.toLowerCase()==="x"){continue}}this.fields[d.tagName.toLowerCase()]=Strophe.getText(d)}b._changeConnectStatus(Strophe.Status.REGISTER,null);return false},submit:function(){var c,b,e,a,d=this._connection;e=$iq({type:"set"}).c("query",{xmlns:Strophe.NS.REGISTER});a=Object.keys(this.fields);for(c=0;c<a.length;c++){b=a[c];e.c(b).t(this.fields[b]).up()}d._changeConnectStatus(Strophe.Status.SUBMITTING,null);d._addSysHandler(this._submit_cb.bind(this),null,"iq",null,null);d.send(e)},_submit_cb:function(f){var b,d,e,a=null,c=this._connection;d=f.getElementsByTagName("query");if(d.length>0){d=d[0];for(b=0;b<d.childNodes.length;b++){e=d.childNodes[b];if(e.tagName.toLowerCase()==="instructions"){this.instructions=Strophe.getText(e);continue}this.fields[e.tagName.toLowerCase()]=Strophe.getText(e)}}if(f.getAttribute("type")==="error"){a=f.getElementsByTagName("error");if(a.length!==1){c._changeConnectStatus(Strophe.Status.SBMTFAIL,"unknown");return false}a=a[0].firstChild.tagName.toLowerCase();if(a==="conflict"){this.registered=true}}else{this.registered=true}if(this.registered){c.jid=this.fields.username+"@"+c.domain;c.pass=this.fields.password}if(a===null){Strophe.info("Registered successful.");c._changeConnectStatus(Strophe.Status.REGISTERED,null)}else{Strophe.info("Registration failed.");c._changeConnectStatus(Strophe.Status.SBMTFAIL,a)}return false},authenticate:function(){var a,b,c=this._connection;if(Strophe.getNodeFromJid(c.jid)===null&&this.authentication.sasl_anonymous){c._changeConnectStatus(Strophe.Status.AUTHENTICATING,null);c._sasl_success_handler=c._addSysHandler(c._sasl_success_cb.bind(c),null,"success",null,null);c._sasl_failure_handler=c._addSysHandler(c._sasl_failure_cb.bind(c),null,"failure",null,null);c.send($build("auth",{xmlns:Strophe.NS.SASL,mechanism:"ANONYMOUS"}).tree())}else{if(Strophe.getNodeFromJid(c.jid)===null){c._changeConnectStatus(Strophe.Status.CONNFAIL,"x-strophe-bad-non-anon-jid");c.disconnect()}else{if(this.authentication.sasl_digest_md5){c._changeConnectStatus(Strophe.Status.AUTHENTICATING,null);c._sasl_challenge_handler=c._addSysHandler(c._sasl_challenge1_cb.bind(c),null,"challenge",null,null);c._sasl_failure_handler=c._addSysHandler(c._sasl_failure_cb.bind(c),null,"failure",null,null);c.send($build("auth",{xmlns:Strophe.NS.SASL,mechanism:"DIGEST-MD5"}).tree())}else{if(this.authentication.sasl_plain){a=Strophe.getBareJidFromJid(c.jid);a=a+"\u0000";a=a+Strophe.getNodeFromJid(c.jid);a=a+"\u0000";a=a+c.pass;c._changeConnectStatus(Strophe.Status.AUTHENTICATING,null);c._sasl_success_handler=c._addSysHandler(c._sasl_success_cb.bind(c),null,"success",null,null);c._sasl_failure_handler=c._addSysHandler(c._sasl_failure_cb.bind(c),null,"failure",null,null);b=Base64.encode(a);c.send($build("auth",{xmlns:Strophe.NS.SASL,mechanism:"PLAIN"}).t(b).tree())}else{c._changeConnectStatus(Strophe.Status.AUTHENTICATING,null);c._addSysHandler(c._auth1_cb.bind(c),null,null,null,"_auth_1");c.send($iq({type:"get",to:c.domain,id:"_auth_1"}).c("query",{xmlns:Strophe.NS.AUTH}).c("username",{}).t(Strophe.getNodeFromJid(c.jid)).tree())}}}}},});