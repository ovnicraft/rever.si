var Occupant,RoomConfig,XmppRoom,__bind=function(a,b){return function(){return a.apply(b,arguments)}};Strophe.addConnectionPlugin("muc",{_connection:null,rooms:[],init:function(a){this._connection=a;this._muc_handler=null;Strophe.addNamespace("MUC_OWNER",Strophe.NS.MUC+"#owner");Strophe.addNamespace("MUC_ADMIN",Strophe.NS.MUC+"#admin");Strophe.addNamespace("MUC_USER",Strophe.NS.MUC+"#user");return Strophe.addNamespace("MUC_ROOMCONF",Strophe.NS.MUC+"#roomconfig")},join:function(a,b,h,g,k,l){var c,i,j,e,d,f=this;i=this.test_append_nick(a,b);c=$pres({from:this._connection.jid,to:i}).c("x",{xmlns:Strophe.NS.MUC});if(l!=null){c.cnode(Strophe.xmlElement("password",[],l))}if((e=this._muc_handler)==null){this._muc_handler=this._connection.addHandler(function(n){var v,w,o,m,p,u,q,s,r,t;v=n.getAttribute("from");if(!v){return true}p=v.split("/")[0];if(!f.rooms[p]){return true}a=f.rooms[p];o={};if(n.nodeName==="message"){o=a._message_handlers}else{if(n.nodeName==="presence"){s=n.getElementsByTagName("x");if(s.length>0){for(r=0,t=s.length;r<t;r++){u=s[r];q=u.getAttribute("xmlns");if(q&&q.match(Strophe.NS.MUC)){o=a._presence_handlers;break}}}}}for(m in o){w=o[m];if(!w(n,a)){delete o[m]}}return true})}if((d=(j=this.rooms)[a])==null){j[a]=new XmppRoom(this,a,b,l)}if(g){this.rooms[a].addHandler("presence",g)}if(h){this.rooms[a].addHandler("message",h)}if(k){this.rooms[a].addHandler("roster",k)}return this._connection.send(c)},leave:function(g,a,d,b){var c,e,f;delete this.rooms[g];if(this.rooms.length===0){this._connection.deleteHandler(this._muc_handler);this._muc_handler=null}f=this.test_append_nick(g,a);e=this._connection.getUniqueId();c=$pres({type:"unavailable",id:e,from:this._connection.jid,to:f});if(b!=null){c.c("status",b)}if(d!=null){this._connection.addHandler(d,null,"presence",null,e)}this._connection.send(c);return e},message:function(a,d,i,b,f){var e,c,h,g;g=this.test_append_nick(a,d);f=f||(d!=null?"chat":"groupchat");c=this._connection.getUniqueId();e=$msg({to:g,from:this._connection.jid,type:f,id:c}).c("body",{xmlns:Strophe.NS.CLIENT}).t(i);e.up();if(b!=null){e.c("html",{xmlns:Strophe.NS.XHTML_IM}).c("body",{xmlns:Strophe.NS.XHTML}).h(b);if(e.node.childNodes.length===0){h=e.node.parentNode;e.up().up();e.node.removeChild(h)}else{e.up().up()}}e.c("x",{xmlns:"jabber:x:event"}).c("composing");this._connection.send(e);return c},groupchat:function(c,a,b){return this.message(c,null,a,b)},invite:function(e,b,d){var c,a;a=this._connection.getUniqueId();c=$msg({from:this._connection.jid,to:e,id:a}).c("x",{xmlns:Strophe.NS.MUC_USER}).c("invite",{to:b});if(d!=null){c.c("reason",d)}this._connection.send(c);return a},directInvite:function(g,d,f,b){var a,e,c;c=this._connection.getUniqueId();a={xmlns:"jabber:x:conference",jid:g};if(f!=null){a.reason=f}if(b!=null){a.password=b}e=$msg({from:this._connection.jid,to:d,id:c}).c("x",a);this._connection.send(e);return c},queryOccupants:function(e,a,c){var b,d;b={xmlns:Strophe.NS.DISCO_ITEMS};d=$iq({from:this._connection.jid,to:e,type:"get"}).c("query",b);return this._connection.sendIQ(d,a,c)},configure:function(d,b,c){var a,e;a=$iq({to:d,type:"get"}).c("query",{xmlns:Strophe.NS.MUC_OWNER});e=a.tree();return this._connection.sendIQ(e,b,c)},cancelConfigure:function(b){var a,c;a=$iq({to:b,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"cancel"});c=a.tree();return this._connection.sendIQ(c)},saveConfiguration:function(a,d,h,c){var g,f,b,e,i;f=$iq({to:a,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER});if(d instanceof Form){d.type="submit";f.cnode(d.toXML())}else{f.c("x",{xmlns:"jabber:x:data",type:"submit"});for(e=0,i=d.length;e<i;e++){g=d[e];f.cnode(g).up()}}b=f.tree();return this._connection.sendIQ(b,h,c)},createInstantRoom:function(d,a,c){var b;b=$iq({to:d,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"});return this._connection.sendIQ(b.tree(),a,c)},setTopic:function(b,a){var c;c=$msg({to:b,from:this._connection.jid,type:"groupchat"}).c("subject",{xmlns:"jabber:client"}).t(a);return this._connection.send(c.tree())},_modifyPrivilege:function(f,c,e,a,b){var d;d=$iq({to:f,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_ADMIN}).cnode(c.node);if(e!=null){d.c("reason",e)}return this._connection.sendIQ(d.tree(),a,b)},modifyRole:function(f,a,g,e,b,d){var c;c=$build("item",{nick:a,role:g});return this._modifyPrivilege(f,c,e,b,d)},kick:function(e,a,d,b,c){return this.modifyRole(e,a,"none",d,b,c)},voice:function(e,a,d,b,c){return this.modifyRole(e,a,"participant",d,b,c)},mute:function(e,a,d,b,c){return this.modifyRole(e,a,"visitor",d,b,c)},op:function(e,a,d,b,c){return this.modifyRole(e,a,"moderator",d,b,c)},deop:function(e,a,d,b,c){return this.modifyRole(e,a,"participant",d,b,c)},modifyAffiliation:function(g,b,c,f,a,e){var d;d=$build("item",{jid:b,affiliation:c});return this._modifyPrivilege(g,d,f,a,e)},ban:function(e,b,d,a,c){return this.modifyAffiliation(e,b,"outcast",d,a,c)},member:function(e,b,d,a,c){return this.modifyAffiliation(e,b,"member",d,a,c)},revoke:function(e,b,d,a,c){return this.modifyAffiliation(e,b,"none",d,a,c)},owner:function(e,b,d,a,c){return this.modifyAffiliation(e,b,"owner",d,a,c)},admin:function(e,b,d,a,c){return this.modifyAffiliation(e,b,"admin",d,a,c)},changeNick:function(d,a){var b,c;c=this.test_append_nick(d,a);b=$pres({from:this._connection.jid,to:c,id:this._connection.getUniqueId()});return this._connection.send(b.tree())},setStatus:function(f,c,b,a){var d,e;e=this.test_append_nick(f,c);d=$pres({from:this._connection.jid,to:e});if(b!=null){d.c("show",b).up()}if(a!=null){d.c("status",a)}return this._connection.send(d.tree())},listRooms:function(d,a,b){var c;c=$iq({to:d,from:this._connection.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS});return this._connection.sendIQ(c,a,b)},test_append_nick:function(b,a){return b+(a!=null?"/"+(Strophe.escapeNode(a)):"")}});XmppRoom=(function(){a.prototype.roster={};a.prototype._message_handlers={};a.prototype._presence_handlers={};a.prototype._roster_handlers={};a.prototype._handler_ids=0;function a(c,e,b,d){this.client=c;this.name=e;this.nick=b;this.password=d;this._roomRosterHandler=__bind(this._roomRosterHandler,this);this._addOccupant=__bind(this._addOccupant,this);if(c.muc){this.client=c.muc}this.name=Strophe.getBareJidFromJid(e);this.client.rooms[this.name]=this;this.addHandler("presence",this._roomRosterHandler)}a.prototype.join=function(b,c,d){return this.client.join(this.name,this.nick,b,c,d,this.password)};a.prototype.leave=function(b,c){this.client.leave(this.name,this.nick,b,c);return delete this.client.rooms[this.name]};a.prototype.message=function(b,d,e,c){return this.client.message(this.name,b,d,e,c)};a.prototype.groupchat=function(b,c){return this.client.groupchat(this.name,b,c)};a.prototype.invite=function(b,c){return this.client.invite(this.name,b,c)};a.prototype.directInvite=function(b,c){return this.client.directInvite(this.name,b,c,this.password)};a.prototype.configure=function(b){return this.client.configure(this.name,b)};a.prototype.cancelConfigure=function(){return this.client.cancelConfigure(this.name)};a.prototype.saveConfiguration=function(b){return this.client.saveConfiguration(this.name,b)};a.prototype.queryOccupants=function(b,c){return this.client.queryOccupants(this.name,b,c)};a.prototype.setTopic=function(b){return this.client.setTopic(this.name,b)};a.prototype.modifyRole=function(b,f,e,c,d){return this.client.modifyRole(this.name,b,f,e,c,d)};a.prototype.kick=function(b,e,c,d){return this.client.kick(this.name,b,e,c,d)};a.prototype.voice=function(b,e,c,d){return this.client.voice(this.name,b,e,c,d)};a.prototype.mute=function(b,e,c,d){return this.client.mute(this.name,b,e,c,d)};a.prototype.op=function(b,e,c,d){return this.client.op(this.name,b,e,c,d)};a.prototype.deop=function(b,e,c,d){return this.client.deop(this.name,b,e,c,d)};a.prototype.modifyAffiliation=function(c,d,f,b,e){return this.client.modifyAffiliation(this.name,c,d,f,b,e)};a.prototype.ban=function(c,e,b,d){return this.client.ban(this.name,c,e,b,d)};a.prototype.member=function(c,e,b,d){return this.client.member(this.name,c,e,b,d)};a.prototype.revoke=function(c,e,b,d){return this.client.revoke(this.name,c,e,b,d)};a.prototype.owner=function(c,e,b,d){return this.client.owner(this.name,c,e,b,d)};a.prototype.admin=function(c,e,b,d){return this.client.admin(this.name,c,e,b,d)};a.prototype.changeNick=function(b){this.nick=b;return this.client.changeNick(this.name,b)};a.prototype.setStatus=function(c,b){return this.client.setStatus(this.name,this.nick,c,b)};a.prototype.addHandler=function(c,b){var d;d=this._handler_ids++;switch(c){case"presence":this._presence_handlers[d]=b;break;case"message":this._message_handlers[d]=b;break;case"roster":this._roster_handlers[d]=b;break;default:this._handler_ids--;return null}return d};a.prototype.removeHandler=function(b){delete this._presence_handlers[b];delete this._message_handlers[b];return delete this._roster_handlers[b]};a.prototype._addOccupant=function(c){var b;b=new Occupant(c,this);this.roster[b.nick]=b;return b};a.prototype._roomRosterHandler=function(g){var f,d,h,c,b,e;f=a._parsePresence(g);b=f.nick;c=f.newnick||null;switch(f.type){case"error":return;case"unavailable":if(c){f.nick=c;if(this.roster.hasOwnProperty(b)&&this.roster.hasOwnProperty(c)){this.roster[b].update(this.roster[c]);this.roster[c]=this.roster[b]}if(this.roster.hasOwnProperty(b)&&!this.roster.hasOwnProperty(c)){this.roster[c]=this.roster[b].update(f)}}delete this.roster[b];break;default:if(this.roster.hasOwnProperty(b)){this.roster[b].update(f)}else{this._addOccupant(f)}}e=this._roster_handlers;for(h in e){d=e[h];if(!d(this.roster,this)){delete this._roster_handlers[h]}}return true};a._parsePresence=function(o){var r,q,m,p,l,k,s,e,n,j,i,h,g,f,d,b;p={};r=o.attributes;p.nick=Strophe.getResourceFromJid(r.from.textContent);p.type=((n=r.type)!=null?n.textContent:void 0)||null;p.states=[];j=o.childNodes;for(l=0,s=j.length;l<s;l++){q=j[l];switch(q.nodeName){case"status":p.status=q.textContent||null;break;case"show":p.show=q.textContent||null;break;case"x":r=q.attributes;if(((i=r.xmlns)!=null?i.textContent:void 0)===Strophe.NS.MUC_USER){h=q.childNodes;for(k=0,e=h.length;k<e;k++){m=h[k];switch(m.nodeName){case"item":r=m.attributes;p.affiliation=((g=r.affiliation)!=null?g.textContent:void 0)||null;p.role=((f=r.role)!=null?f.textContent:void 0)||null;p.jid=((d=r.jid)!=null?d.textContent:void 0)||null;p.newnick=((b=r.nick)!=null?b.textContent:void 0)||null;break;case"status":if(m.attributes.code){p.states.push(m.attributes.code.textContent)}}}}}}return p};return a})();RoomConfig=(function(){function a(b){this.parse=__bind(this.parse,this);if(b!=null){this.parse(b)}}a.prototype.parse=function(o){var i,n,d,m,j,k,g,f,e,l,c,b,h;k=o.getElementsByTagName("query")[0].childNodes;this.identities=[];this.features=[];this.x=[];for(g=0,l=k.length;g<l;g++){d=k[g];n=d.attributes;switch(d.nodeName){case"identity":j={};for(f=0,c=n.length;f<c;f++){i=n[f];j[i.name]=i.textContent}this.identities.push(j);break;case"feature":this.features.push(n["var"].textContent);break;case"x":n=d.childNodes[0].attributes;if((!n["var"].textContent==="FORM_TYPE")||(!n.type.textContent==="hidden")){break}h=d.childNodes;for(e=0,b=h.length;e<b;e++){m=h[e];if(!(!m.attributes.type)){continue}n=m.attributes;this.x.push({"var":n["var"].textContent,label:n.label.textContent||"",value:m.firstChild.textContent||""})}}}return{identities:this.identities,features:this.features,x:this.x}};return a})();Occupant=(function(){function a(b,c){this.room=c;this.update=__bind(this.update,this);this.admin=__bind(this.admin,this);this.owner=__bind(this.owner,this);this.revoke=__bind(this.revoke,this);this.member=__bind(this.member,this);this.ban=__bind(this.ban,this);this.modifyAffiliation=__bind(this.modifyAffiliation,this);this.deop=__bind(this.deop,this);this.op=__bind(this.op,this);this.mute=__bind(this.mute,this);this.voice=__bind(this.voice,this);this.kick=__bind(this.kick,this);this.modifyRole=__bind(this.modifyRole,this);this.update(b)}a.prototype.modifyRole=function(e,d,b,c){return this.room.modifyRole(this.nick,e,d,b,c)};a.prototype.kick=function(d,b,c){return this.room.kick(this.nick,d,b,c)};a.prototype.voice=function(d,b,c){return this.room.voice(this.nick,d,b,c)};a.prototype.mute=function(d,b,c){return this.room.mute(this.nick,d,b,c)};a.prototype.op=function(d,b,c){return this.room.op(this.nick,d,b,c)};a.prototype.deop=function(d,b,c){return this.room.deop(this.nick,d,b,c)};a.prototype.modifyAffiliation=function(c,e,b,d){return this.room.modifyAffiliation(this.jid,c,e,b,d)};a.prototype.ban=function(d,b,c){return this.room.ban(this.jid,d,b,c)};a.prototype.member=function(d,b,c){return this.room.member(this.jid,d,b,c)};a.prototype.revoke=function(d,b,c){return this.room.revoke(this.jid,d,b,c)};a.prototype.owner=function(d,b,c){return this.room.owner(this.jid,d,b,c)};a.prototype.admin=function(d,b,c){return this.room.admin(this.jid,d,b,c)};a.prototype.update=function(b){this.nick=b.nick||null;this.affiliation=b.affiliation||null;this.role=b.role||null;this.jid=b.jid||null;this.status=b.status||null;this.show=b.show||null;return this};return a})();