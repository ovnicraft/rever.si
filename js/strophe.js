var Base64=function(){return{encode:function(d){var a="",c,b,e,f,g,l,n=0;do c=d.charCodeAt(n++),b=d.charCodeAt(n++),e=d.charCodeAt(n++),f=c>>2,c=(c&3)<<4|b>>4,g=(b&15)<<2|e>>6,l=e&63,isNaN(b)?g=l=64:isNaN(e)&&(l=64),a=a+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(f)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(c)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(g)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(l);while(n<d.length);return a},decode:function(d){var a="",c,b,e,f,g,l=0;d=d.replace(/[^A-Za-z0-9\+\/\=]/g,"");do c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(d.charAt(l++)),b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(d.charAt(l++)),f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(d.charAt(l++)),g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(d.charAt(l++)),c=c<<2|b>>4,b=(b&15)<<4|f>>2,e=(f&3)<<6|g,a+=String.fromCharCode(c),64!=f&&(a+=String.fromCharCode(b)),64!=g&&(a+=String.fromCharCode(e));while(l<d.length);return a}}}(),MD5=function(){var d=function(g,a){var l=(g&65535)+(a&65535);return(g>>16)+(a>>16)+(l>>16)<<16|l&65535},a=function(g){for(var a=[],l=0;l<8*g.length;l+=8)a[l>>5]|=(g.charCodeAt(l/8)&255)<<l%32;return a},c=function(g){for(var a="",l=0;l<32*g.length;l+=8)a+=String.fromCharCode(g[l>>5]>>>l%32&255);return a},b=function(g){for(var a="",l=0;l<4*g.length;l++)a+="0123456789abcdef".charAt(g[l>>2]>>8*(l%4)+4&15)+"0123456789abcdef".charAt(g[l>>2]>>8*(l%4)&15);return a},e=function(g){for(var a="",l,d,c=0;c<4*g.length;c+=3){l=(g[c>>2]>>8*(c%4)&255)<<16|(g[c+1>>2]>>8*((c+1)%4)&255)<<8|g[c+2>>2]>>8*((c+2)%4)&255;for(d=0;4>d;d++)a=8*c+6*d>32*g.length?a+"":a+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(l>>6*(3-d)&63)}return a},f=function(g,a,l,c,f,b){g=d(d(a,g),d(c,b));return d(g<<f|g>>>32-f,l)},g=function(g,a,l,d,c,b,n){return f(a&l|~a&d,g,a,c,b,n)},l=function(g,a,l,d,c,b,n){return f(a&d|l&~d,g,a,c,b,n)},n=function(g,a,l,d,c,b,n){return f(l^(a|~d),g,a,c,b,n)},s=function(a,c){a[c>>5]|=128<<c%32;a[(c+64>>>9<<4)+14]=c;for(var b=1732584193,e=-271733879,h=-1732584194,k=271733878,s,r,u,v,m=0;m<a.length;m+=16)s=b,r=e,u=h,v=k,b=g(b,e,h,k,a[m+0],7,-680876936),k=g(k,b,e,h,a[m+1],12,-389564586),h=g(h,k,b,e,a[m+2],17,606105819),e=g(e,h,k,b,a[m+3],22,-1044525330),b=g(b,e,h,k,a[m+4],7,-176418897),k=g(k,b,e,h,a[m+5],12,1200080426),h=g(h,k,b,e,a[m+6],17,-1473231341),e=g(e,h,k,b,a[m+7],22,-45705983),b=g(b,e,h,k,a[m+8],7,1770035416),k=g(k,b,e,h,a[m+9],12,-1958414417),h=g(h,k,b,e,a[m+10],17,-42063),e=g(e,h,k,b,a[m+11],22,-1990404162),b=g(b,e,h,k,a[m+12],7,1804603682),k=g(k,b,e,h,a[m+13],12,-40341101),h=g(h,k,b,e,a[m+14],17,-1502002290),e=g(e,h,k,b,a[m+15],22,1236535329),b=l(b,e,h,k,a[m+1],5,-165796510),k=l(k,b,e,h,a[m+6],9,-1069501632),h=l(h,k,b,e,a[m+11],14,643717713),e=l(e,h,k,b,a[m+0],20,-373897302),b=l(b,e,h,k,a[m+5],5,-701558691),k=l(k,b,e,h,a[m+10],9,38016083),h=l(h,k,b,e,a[m+15],14,-660478335),e=l(e,h,k,b,a[m+4],20,-405537848),b=l(b,e,h,k,a[m+9],5,568446438),k=l(k,b,e,h,a[m+14],9,-1019803690),h=l(h,k,b,e,a[m+3],14,-187363961),e=l(e,h,k,b,a[m+8],20,1163531501),b=l(b,e,h,k,a[m+13],5,-1444681467),k=l(k,b,e,h,a[m+2],9,-51403784),h=l(h,k,b,e,a[m+7],14,1735328473),e=l(e,h,k,b,a[m+12],20,-1926607734),b=f(e^h^k,b,e,a[m+5],4,-378558),k=f(b^e^h,k,b,a[m+8],11,-2022574463),h=f(k^b^e,h,k,a[m+11],16,1839030562),e=f(h^k^b,e,h,a[m+14],23,-35309556),b=f(e^h^k,b,e,a[m+1],4,-1530992060),k=f(b^e^h,k,b,a[m+4],11,1272893353),h=f(k^b^e,h,k,a[m+7],16,-155497632),e=f(h^k^b,e,h,a[m+10],23,-1094730640),b=f(e^h^k,b,e,a[m+13],4,681279174),k=f(b^e^h,k,b,a[m+0],11,-358537222),h=f(k^b^e,h,k,a[m+3],16,-722521979),e=f(h^k^b,e,h,a[m+6],23,76029189),b=f(e^h^k,b,e,a[m+9],4,-640364487),k=f(b^e^h,k,b,a[m+12],11,-421815835),h=f(k^b^e,h,k,a[m+15],16,530742520),e=f(h^k^b,e,h,a[m+2],23,-995338651),b=n(b,e,h,k,a[m+0],6,-198630844),k=n(k,b,e,h,a[m+7],10,1126891415),h=n(h,k,b,e,a[m+14],15,-1416354905),e=n(e,h,k,b,a[m+5],21,-57434055),b=n(b,e,h,k,a[m+12],6,1700485571),k=n(k,b,e,h,a[m+3],10,-1894986606),h=n(h,k,b,e,a[m+10],15,-1051523),e=n(e,h,k,b,a[m+1],21,-2054922799),b=n(b,e,h,k,a[m+8],6,1873313359),k=n(k,b,e,h,a[m+15],10,-30611744),h=n(h,k,b,e,a[m+6],15,-1560198380),e=n(e,h,k,b,a[m+13],21,1309151649),b=n(b,e,h,k,a[m+4],6,-145523070),k=n(k,b,e,h,a[m+11],10,-1120210379),h=n(h,k,b,e,a[m+2],15,718787259),e=n(e,h,k,b,a[m+9],21,-343485551),b=d(b,s),e=d(e,r),h=d(h,u),k=d(k,v);return[b,e,h,k]},r=function(g,b){var l=a(g);16<l.length&&(l=s(l,8*g.length));for(var c=Array(16),d=Array(16),e=0;16>e;e++)c[e]=l[e]^909522486,d[e]=l[e]^1549556828;l=s(c.concat(a(b)),512+8*b.length);return s(d.concat(l),640)};return{hexdigest:function(g){return b(s(a(g),8*g.length))},b64digest:function(g){return e(s(a(g),8*g.length))},hash:function(g){return c(s(a(g),8*g.length))},hmac_hexdigest:function(g,a){return b(r(g,a))},hmac_b64digest:function(g,a){return e(r(g,a))},hmac_hash:function(g,a){return c(r(g,a))},test:function(){return"900150983cd24fb0d6963f7d28e17f72"===MD5.hexdigest("abc")}}}();Function.prototype.bind||(Function.prototype.bind=function(d){var a=this,c=Array.prototype.slice,b=Array.prototype.concat,e=c.call(arguments,1);return function(){return a.apply(d?d:this,b.call(e,c.call(arguments,0)))}});Array.prototype.indexOf||(Array.prototype.indexOf=function(d,a){var c=this.length,b=Number(a)||0,b=0>b?Math.ceil(b):Math.floor(b);for(0>b&&(b+=c);b<c;b++)if(b in this&&this[b]===d)return b;return-1});(function(d){function a(g,a){return new f.Builder(g,a)}function c(g){return new f.Builder("message",g)}function b(g){return new f.Builder("iq",g)}function e(g){return new f.Builder("presence",g)}var f;f={VERSION:"1.0.2",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas"},addNamespace:function(g,a){f.NS[g]=a},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4},TIMEOUT:1.1,SECONDARY_TIMEOUT:0.1,forEachChild:function(g,a,b){var c,d;for(c=0;c<g.childNodes.length;c++)d=g.childNodes[c],d.nodeType==f.ElementType.NORMAL&&(!a||this.isTagEqual(d,a))&&b(d)},isTagEqual:function(g,a){return g.tagName.toLowerCase()==a.toLowerCase()},_xmlGenerator:null,_makeGenerator:function(){var g;void 0===document.implementation.createDocument?(g=this._getIEXmlDom(),g.appendChild(g.createElement("strophe"))):g=document.implementation.createDocument("jabber:client","strophe",null);return g},xmlGenerator:function(){f._xmlGenerator||(f._xmlGenerator=f._makeGenerator());return f._xmlGenerator},_getIEXmlDom:function(){for(var g=null,a="Msxml2.DOMDocument.6.0 Msxml2.DOMDocument.5.0 Msxml2.DOMDocument.4.0 MSXML2.DOMDocument.3.0 MSXML2.DOMDocument MSXML.DOMDocument Microsoft.XMLDOM".split(" "),b=0;b<a.length;b++)if(null===g)try{g=new ActiveXObject(a[b])}catch(c){g=null}else break;return g},xmlElement:function(a){if(!a)return null;var b=f.xmlGenerator().createElement(a),c,d,e;for(c=1;c<arguments.length;c++)if(arguments[c])if("string"==typeof arguments[c]||"number"==typeof arguments[c])b.appendChild(f.xmlTextNode(arguments[c]));else if("object"==typeof arguments[c]&&"function"==typeof arguments[c].sort)for(d=0;d<arguments[c].length;d++)"object"==typeof arguments[c][d]&&"function"==typeof arguments[c][d].sort&&b.setAttribute(arguments[c][d][0],arguments[c][d][1]);else if("object"==typeof arguments[c])for(e in arguments[c])arguments[c].hasOwnProperty(e)&&b.setAttribute(e,arguments[c][e]);return b},xmlescape:function(a){a=a.replace(/\&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/'/g,"&apos;");return a.replace(/"/g,"&quot;")},xmlTextNode:function(a){a=f.xmlescape(a);return f.xmlGenerator().createTextNode(a)},getText:function(a){if(!a)return null;var b="";0===a.childNodes.length&&a.nodeType==f.ElementType.TEXT&&(b+=a.nodeValue);for(var c=0;c<a.childNodes.length;c++)a.childNodes[c].nodeType==f.ElementType.TEXT&&(b+=a.childNodes[c].nodeValue);return b},copyElement:function(a){var b,c;if(a.nodeType==f.ElementType.NORMAL){c=f.xmlElement(a.tagName);for(b=0;b<a.attributes.length;b++)c.setAttribute(a.attributes[b].nodeName.toLowerCase(),a.attributes[b].value);for(b=0;b<a.childNodes.length;b++)c.appendChild(f.copyElement(a.childNodes[b]))}else a.nodeType==f.ElementType.TEXT&&(c=f.xmlGenerator().createTextNode(a.nodeValue));return c},escapeNode:function(a){return a.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(a){return a.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(a){return 0>a.indexOf("@")?null:a.split("@")[0]},getDomainFromJid:function(a){a=f.getBareJidFromJid(a);if(0>a.indexOf("@"))return a;a=a.split("@");a.splice(0,1);return a.join("@")},getResourceFromJid:function(a){a=a.split("/");if(2>a.length)return null;a.splice(0,1);return a.join("/")},getBareJidFromJid:function(a){return a?a.split("/")[0]:null},log:function(a,b){},debug:function(a){this.log(this.LogLevel.DEBUG,a)},info:function(a){this.log(this.LogLevel.INFO,a)},warn:function(a){this.log(this.LogLevel.WARN,a)},error:function(a){this.log(this.LogLevel.ERROR,a)},fatal:function(a){this.log(this.LogLevel.FATAL,a)},serialize:function(a){var b;if(!a)return null;"function"===typeof a.tree&&(a=a.tree());var c=a.nodeName,d,e;a.getAttribute("_realname")&&(c=a.getAttribute("_realname"));b="<"+c;for(d=0;d<a.attributes.length;d++)"_realname"!=a.attributes[d].nodeName&&(b+=" "+a.attributes[d].nodeName.toLowerCase()+"='"+a.attributes[d].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/</g,"&lt;")+"'");if(0<a.childNodes.length){b+=">";for(d=0;d<a.childNodes.length;d++)switch(e=a.childNodes[d],e.nodeType){case f.ElementType.NORMAL:b+=f.serialize(e);break;case f.ElementType.TEXT:b+=f.xmlescape(e.nodeValue);break;case f.ElementType.CDATA:b+="<![CDATA["+e.nodeValue+"]]\x3e"}b+="</"+c+">"}else b+="/>";return b},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(a,b){f._connectionPlugins[a]=b},Builder:function(a,b){if("presence"==a||"message"==a||"iq"==a)b&&!b.xmlns?b.xmlns=f.NS.CLIENT:b||(b={xmlns:f.NS.CLIENT});this.node=this.nodeTree=f.xmlElement(a,b)}};f.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return f.serialize(this.nodeTree)},up:function(){this.node=this.node.parentNode;return this},attrs:function(a){for(var b in a)a.hasOwnProperty(b)&&this.node.setAttribute(b,a[b]);return this},c:function(a,b,c){a=f.xmlElement(a,b,c);this.node.appendChild(a);c||(this.node=a);return this},cnode:function(a){var b=f.xmlGenerator();try{var c=void 0!==b.importNode}catch(d){c=!1}a=c?b.importNode(a,!0):f.copyElement(a);this.node.appendChild(a);this.node=a;return this},t:function(a){a=f.xmlTextNode(a);this.node.appendChild(a);return this}};f.Handler=function(a,b,c,d,e,q,p){this.handler=a;this.ns=b;this.name=c;this.type=d;this.id=e;this.options=p||{matchbare:!1};this.options.matchBare||(this.options.matchBare=!1);this.from=this.options.matchBare?q?f.getBareJidFromJid(q):null:q;this.user=!0};f.Handler.prototype={isMatch:function(a){var b,c=null,c=this.options.matchBare?f.getBareJidFromJid(a.getAttribute("from")):a.getAttribute("from");b=!1;if(this.ns){var d=this;f.forEachChild(a,null,function(a){a.getAttribute("xmlns")==d.ns&&(b=!0)});b=b||a.getAttribute("xmlns")==this.ns}else b=!0;return b&&(!this.name||f.isTagEqual(a,this.name))&&(!this.type||a.getAttribute("type")==this.type)&&(!this.id||a.getAttribute("id")==this.id)&&(!this.from||c==this.from)?!0:!1},run:function(a){var b=null;try{b=this.handler(a)}catch(c){throw c.sourceURL?f.fatal("error: "+this.handler+" "+c.sourceURL+":"+c.line+" - "+c.name+": "+c.message):c.fileName?("undefined"!=typeof console&&(console.trace(),console.error(this.handler," - error - ",c,c.message)),f.fatal("error: "+this.handler+" "+c.fileName+":"+c.lineNumber+" - "+c.name+": "+c.message)):f.fatal("error: "+this.handler),c;}return b},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}};f.TimedHandler=function(a,b){this.period=a;this.handler=b;this.lastCalled=(new Date).getTime();this.user=!0};f.TimedHandler.prototype={run:function(){this.lastCalled=(new Date).getTime();return this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}};f.Request=function(a,b,c,d){this.id=++f._requestId;this.xmlData=a;this.data=f.serialize(a);this.func=this.origFunc=b;this.rid=c;this.date=NaN;this.sends=d||0;this.abort=!1;this.dead=null;this.age=function(){return!this.date?0:(new Date-this.date)/1E3};this.timeDead=function(){return!this.dead?0:(new Date-this.dead)/1E3};this.xhr=this._newXHR()};f.Request.prototype={getResponse:function(){var a=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if(a=this.xhr.responseXML.documentElement,"parsererror"==a.tagName)throw f.error("invalid response received"),f.error("responseText: "+this.xhr.responseText),f.error("responseXML: "+f.serialize(this.xhr.responseXML)),"parsererror";}else this.xhr.responseText&&(f.error("invalid response received"),f.error("responseText: "+this.xhr.responseText),f.error("responseXML: "+f.serialize(this.xhr.responseXML)));return a},_newXHR:function(){var a=null;window.XMLHttpRequest?(a=new XMLHttpRequest,a.overrideMimeType&&a.overrideMimeType("text/xml")):window.ActiveXObject&&(a=new ActiveXObject("Microsoft.XMLHTTP"));a.onreadystatechange=this.func.bind(null,this);return a}};f.Connection=function(a){this.service=a;this.jid="";this.rid=Math.floor(4294967295*Math.random());this.features=this.streamId=this.sid=null;this.do_bind=this.do_session=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._disconnectTimeout=this._idleTimeout=null;this.connected=this.disconnecting=this.authenticated=!1;this.errors=0;this.paused=!1;this.hold=1;this.wait=60;this.window=5;this._data=[];this._requests=[];this._uniqueId=Math.round(1E4*Math.random());this._sasl_challenge_handler=this._sasl_failure_handler=this._sasl_success_handler=null;this._idleTimeout=setTimeout(this._onIdle.bind(this),100);for(var b in f._connectionPlugins)f._connectionPlugins.hasOwnProperty(b)&&(a=function(){},a.prototype=f._connectionPlugins[b],this[b]=new a,this[b].init(this))};f.Connection.prototype={reset:function(){this.rid=Math.floor(4294967295*Math.random());this.streamId=this.sid=null;this.do_bind=this.do_session=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this.connected=this.disconnecting=this.authenticated=!1;this.errors=0;this._requests=[];this._uniqueId=Math.round(1E4*Math.random())},pause:function(){this.paused=!0},resume:function(){this.paused=!1},getUniqueId:function(a){return"string"==typeof a||"number"==typeof a?++this._uniqueId+":"+a:++this._uniqueId+""},connect:function(a,b,c,d,e){this.jid=a;this.pass=b;this.connect_callback=c;this.authenticated=this.connected=this.disconnecting=!1;this.errors=0;this.wait=d||this.wait;this.hold=e||this.hold;this.domain=f.getDomainFromJid(this.jid);a=this._buildBody().attrs({to:this.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":f.NS.BOSH});this._changeConnectStatus(f.Status.CONNECTING,null);this._requests.push(new f.Request(a.tree(),this._onRequestStateChange.bind(this,this._connect_cb.bind(this)),a.tree().getAttribute("rid")));this._throttledRequestHandler()},attach:function(a,b,c,d,e,q,p){this.jid=a;this.sid=b;this.rid=c;this.connect_callback=d;this.domain=f.getDomainFromJid(this.jid);this.connected=this.authenticated=!0;this.wait=e||this.wait;this.hold=q||this.hold;this.window=p||this.window;this._changeConnectStatus(f.Status.ATTACHED,null)},xmlInput:function(a){},xmlOutput:function(a){},rawInput:function(a){},rawOutput:function(a){},send:function(a){if(null!==a){if("function"===typeof a.sort)for(var b=0;b<a.length;b++)this._queueData(a[b]);else"function"===typeof a.tree?this._queueData(a.tree()):this._queueData(a);this._throttledRequestHandler();clearTimeout(this._idleTimeout);this._idleTimeout=setTimeout(this._onIdle.bind(this),100)}},flush:function(){clearTimeout(this._idleTimeout);this._onIdle()},sendIQ:function(a,b,c,d){var e=null,f=this;"function"===typeof a.tree&&(a=a.tree());var p=a.getAttribute("id");p||(p=this.getUniqueId("sendIQ"),a.setAttribute("id",p));var t=this.addHandler(function(a){e&&f.deleteTimedHandler(e);var d=a.getAttribute("type");if("result"==d)b&&b(a);else if("error"==d)c&&c(a);else throw{name:"StropheError",message:"Got bad IQ type of "+d};},null,"iq",null,p);d&&(e=this.addTimedHandler(d,function(){f.deleteHandler(t);c&&c(null);return!1}));this.send(a);return p},_queueData:function(a){if(null===a||!a.tagName||!a.childNodes)throw{name:"StropheError",message:"Cannot queue non-DOMElement."};this._data.push(a)},_sendRestart:function(){this._data.push("restart");this._throttledRequestHandler();clearTimeout(this._idleTimeout);this._idleTimeout=setTimeout(this._onIdle.bind(this),100)},addTimedHandler:function(a,b){var c=new f.TimedHandler(a,b);this.addTimeds.push(c);return c},deleteTimedHandler:function(a){this.removeTimeds.push(a)},addHandler:function(a,b,c,d,e,q,p){a=new f.Handler(a,b,c,d,e,q,p);this.addHandlers.push(a);return a},deleteHandler:function(a){this.removeHandlers.push(a)},disconnect:function(a){this._changeConnectStatus(f.Status.DISCONNECTING,a);f.info("Disconnect was called because: "+a);this.connected&&(this._disconnectTimeout=this._addSysTimedHandler(3E3,this._onDisconnectTimeout.bind(this)),this._sendTerminate())},_changeConnectStatus:function(a,b){for(var c in f._connectionPlugins)if(f._connectionPlugins.hasOwnProperty(c)){var d=this[c];if(d.statusChanged)try{d.statusChanged(a,b)}catch(e){f.error(""+c+" plugin caused an exception changing status: "+e)}}if(this.connect_callback)try{this.connect_callback(a,b)}catch(q){f.error("User connection callback caused an exception: "+q)}},_buildBody:function(){var b=a("body",{rid:this.rid++,xmlns:f.NS.HTTPBIND});null!==this.sid&&b.attrs({sid:this.sid});return b},_removeRequest:function(a){f.debug("removing request");var b;for(b=this._requests.length-1;0<=b;b--)a==this._requests[b]&&this._requests.splice(b,1);a.xhr.onreadystatechange=function(){};this._throttledRequestHandler()},_restartRequest:function(a){var b=this._requests[a];null===b.dead&&(b.dead=new Date);this._processRequest(a)},_processRequest:function(a){var b=this._requests[a],c=-1;try{4==b.xhr.readyState&&(c=b.xhr.status)}catch(d){f.error("caught an error in _requests["+a+"], reqStatus: "+c)}"undefined"==typeof c&&(c=-1);if(5<b.sends)this._onDisconnectTimeout();else{var e=b.age(),e=!isNaN(e)&&e>Math.floor(f.TIMEOUT*this.wait),q=null!==b.dead&&b.timeDead()>Math.floor(f.SECONDARY_TIMEOUT*this.wait),c=4==b.xhr.readyState&&(1>c||500<=c);if(e||q||c)q&&f.error("Request "+this._requests[a].id+" timed out (secondary), restarting"),b.abort=!0,b.xhr.abort(),b.xhr.onreadystatechange=function(){},this._requests[a]=new f.Request(b.xmlData,b.origFunc,b.rid,b.sends),b=this._requests[a];if(0===b.xhr.readyState){f.debug("request id "+b.id+"."+b.sends+" posting");try{b.xhr.open("POST",this.service,!0)}catch(p){f.error("XHR open failed.");this.connected||this._changeConnectStatus(f.Status.CONNFAIL,"bad-service");this.disconnect();return}a=function(){b.date=new Date;b.xhr.send(b.data)};1<b.sends?(c=1E3*Math.min(Math.floor(f.TIMEOUT*this.wait),Math.pow(b.sends,3)),setTimeout(a,c)):a();b.sends++;this.xmlOutput!==f.Connection.prototype.xmlOutput&&this.xmlOutput(b.xmlData);this.rawOutput!==f.Connection.prototype.rawOutput&&this.rawOutput(b.data)}else f.debug("_processRequest: "+(0===a?"first":"second")+" request has readyState of "+b.xhr.readyState)}},_throttledRequestHandler:function(){this._requests?f.debug("_throttledRequestHandler called with "+this._requests.length+" requests"):f.debug("_throttledRequestHandler called with undefined requests");this._requests&&0!==this._requests.length&&(0<this._requests.length&&this._processRequest(0),1<this._requests.length&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))},_onRequestStateChange:function(a,b){f.debug("request id "+b.id+"."+b.sends+" state changed to "+b.xhr.readyState);if(b.abort)b.abort=!1;else{var c;if(4==b.xhr.readyState){c=0;try{c=b.xhr.status}catch(d){}"undefined"==typeof c&&(c=0);if(this.disconnecting&&400<=c)this._hitError(c);else{var e=this._requests[0]==b,q=this._requests[1]==b;if(0<c&&500>c||5<b.sends)this._removeRequest(b),f.debug("request id "+b.id+" should now be removed");if(200==c)(q||e&&0<this._requests.length&&this._requests[0].age()>Math.floor(f.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),f.debug("request id "+b.id+"."+b.sends+" got 200"),a(b),this.errors=0;else if(f.error("request id "+b.id+"."+b.sends+" error "+c+" happened"),0===c||400<=c&&600>c||12E3<=c)this._hitError(c),400<=c&&500>c&&(this._changeConnectStatus(f.Status.DISCONNECTING,null),this._doDisconnect());0<c&&500>c||5<b.sends||this._throttledRequestHandler()}}}},_hitError:function(a){this.errors++;f.warn("request errored, status: "+a+", number of errors: "+this.errors);4<this.errors&&this._onDisconnectTimeout()},_doDisconnect:function(){f.info("_doDisconnect was called");this.disconnecting=this.authenticated=!1;this.streamId=this.sid=null;this.rid=Math.floor(4294967295*Math.random());this.connected&&(this._changeConnectStatus(f.Status.DISCONNECTED,null),this.connected=!1);this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[]},_dataRecv:function(a){try{var b=a.getResponse()}catch(c){if("parsererror"!=c)throw c;this.disconnect("strophe-parsererror")}if(null!==b){this.xmlInput!==f.Connection.prototype.xmlInput&&this.xmlInput(b);for(this.rawInput!==f.Connection.prototype.rawInput&&this.rawInput(f.serialize(b));0<this.removeHandlers.length;)a=this.removeHandlers.pop(),a=this.handlers.indexOf(a),0<=a&&this.handlers.splice(a,1);for(;0<this.addHandlers.length;)this.handlers.push(this.addHandlers.pop());if(this.disconnecting&&0===this._requests.length)this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null,this._doDisconnect();else if(a=b.getAttribute("type"),null!==a&&"terminate"==a)this.disconnecting||(a=b.getAttribute("condition"),b=b.getElementsByTagName("conflict"),null!==a?("remote-stream-error"==a&&0<b.length&&(a="conflict"),this._changeConnectStatus(f.Status.CONNFAIL,a)):this._changeConnectStatus(f.Status.CONNFAIL,"unknown"),this.disconnect());else{var d=this;f.forEachChild(b,null,function(a){var b,c;c=d.handlers;d.handlers=[];for(b=0;b<c.length;b++){var e=c[b];try{e.isMatch(a)&&(d.authenticated||!e.user)?e.run(a)&&d.handlers.push(e):d.handlers.push(e)}catch(f){}}})}}},_sendTerminate:function(){f.info("_sendTerminate was called");var a=this._buildBody().attrs({type:"terminate"});this.authenticated&&a.c("presence",{xmlns:f.NS.CLIENT,type:"unavailable"});this.disconnecting=!0;a=new f.Request(a.tree(),this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),a.tree().getAttribute("rid"));this._requests.push(a);this._throttledRequestHandler()},_connect_cb:function(c){f.info("_connect_cb was called");this.connected=!0;if(c=c.getResponse()){this.xmlInput!==f.Connection.prototype.xmlInput&&this.xmlInput(c);this.rawInput!==f.Connection.prototype.rawInput&&this.rawInput(f.serialize(c));var d=c.getAttribute("type");if(null!==d&&"terminate"==d)d=c.getAttribute("condition"),c=c.getElementsByTagName("conflict"),null!==d?("remote-stream-error"==d&&0<c.length&&(d="conflict"),this._changeConnectStatus(f.Status.CONNFAIL,d)):this._changeConnectStatus(f.Status.CONNFAIL,"unknown");else{this.sid||(this.sid=c.getAttribute("sid"));this.stream_id||(this.stream_id=c.getAttribute("authid"));if(d=c.getAttribute("requests"))this.window=parseInt(d,10);if(d=c.getAttribute("hold"))this.hold=parseInt(d,10);if(d=c.getAttribute("wait"))this.wait=parseInt(d,10);var e=d=!1,s=!1;c=c.getElementsByTagName("mechanism");var r,q;if(0<c.length){for(r=0;r<c.length;r++)q=f.getText(c[r]),"DIGEST-MD5"==q?e=!0:"PLAIN"==q?d=!0:"ANONYMOUS"==q&&(s=!0);null===f.getNodeFromJid(this.jid)&&s?(this._changeConnectStatus(f.Status.AUTHENTICATING,null),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(a("auth",{xmlns:f.NS.SASL,mechanism:"ANONYMOUS"}).tree())):null===f.getNodeFromJid(this.jid)?(this._changeConnectStatus(f.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),this.disconnect()):e?(this._changeConnectStatus(f.Status.AUTHENTICATING,null),this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge1_cb.bind(this),null,"challenge",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),this.send(a("auth",{xmlns:f.NS.SASL,mechanism:"DIGEST-MD5"}).tree())):d?(c=f.getBareJidFromJid(this.jid),c=c+"\x00"+f.getNodeFromJid(this.jid),c+="\x00",c+=this.pass,this._changeConnectStatus(f.Status.AUTHENTICATING,null),this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null),this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null),c=Base64.encode(c),this.send(a("auth",{xmlns:f.NS.SASL,mechanism:"PLAIN"}).t(c).tree())):(this._changeConnectStatus(f.Status.AUTHENTICATING,null),this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1"),this.send(b({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:f.NS.AUTH}).c("username",{}).t(f.getNodeFromJid(this.jid)).tree()))}else c=this._buildBody(),this._requests.push(new f.Request(c.tree(),this._onRequestStateChange.bind(this,this._connect_cb.bind(this)),c.tree().getAttribute("rid"))),this._throttledRequestHandler()}}},_sasl_challenge1_cb:function(b){var c=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/,d=Base64.decode(f.getText(b));b=MD5.hexdigest(""+1234567890*Math.random());var e="",r=null,q="",p;for(this.deleteHandler(this._sasl_failure_handler);d.match(c);)switch(p=d.match(c),d=d.replace(p[0],""),p[2]=p[2].replace(/^"(.+)"$/,"$1"),p[1]){case"realm":e=p[2];break;case"nonce":q=p[2];break;case"host":r=p[2]}c="xmpp/"+this.domain;null!==r&&(c=c+"/"+r);r=MD5.hash(f.getNodeFromJid(this.jid)+":"+e+":"+this.pass)+":"+q+":"+b;d="AUTHENTICATE:"+c;p=""+("username="+this._quote(f.getNodeFromJid(this.jid))+",");p+="realm="+this._quote(e)+",";p+="nonce="+this._quote(q)+",";p+="cnonce="+this._quote(b)+",";p=p+'nc="00000001",qop="auth",'+("digest-uri="+this._quote(c)+",");p+="response="+this._quote(MD5.hexdigest(MD5.hexdigest(r)+":"+q+":00000001:"+b+":auth:"+MD5.hexdigest(d)))+",";p+='charset="utf-8"';this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge2_cb.bind(this),null,"challenge",null,null);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(a("response",{xmlns:f.NS.SASL}).t(Base64.encode(p)).tree());return!1},_quote:function(a){return'"'+a.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},_sasl_challenge2_cb:function(b){this.deleteHandler(this._sasl_success_handler);this.deleteHandler(this._sasl_failure_handler);this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this.send(a("response",{xmlns:f.NS.SASL}).tree());return!1},_auth1_cb:function(a){a=b({type:"set",id:"_auth_2"}).c("query",{xmlns:f.NS.AUTH}).c("username",{}).t(f.getNodeFromJid(this.jid)).up().c("password").t(this.pass);f.getResourceFromJid(this.jid)||(this.jid=f.getBareJidFromJid(this.jid)+"/strophe");a.up().c("resource",{}).t(f.getResourceFromJid(this.jid));this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2");this.send(a.tree());return!1},_sasl_success_cb:function(a){f.info("SASL authentication succeeded.");this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);this._addSysHandler(this._sasl_auth1_cb.bind(this),null,"stream:features",null,null);this._sendRestart();return!1},_sasl_auth1_cb:function(a){this.features=a;var c,d;for(c=0;c<a.childNodes.length;c++)d=a.childNodes[c],"bind"==d.nodeName&&(this.do_bind=!0),"session"==d.nodeName&&(this.do_session=!0);this.do_bind?(this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2"),(a=f.getResourceFromJid(this.jid))?this.send(b({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:f.NS.BIND}).c("resource",{}).t(a).tree()):this.send(b({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:f.NS.BIND}).tree())):this._changeConnectStatus(f.Status.AUTHFAIL,null);return!1},_sasl_bind_cb:function(a){if("error"==a.getAttribute("type"))return f.info("SASL binding failed."),this._changeConnectStatus(f.Status.AUTHFAIL,null),!1;a=a.getElementsByTagName("bind");if(0<a.length)a=a[0].getElementsByTagName("jid"),0<a.length&&(this.jid=f.getText(a[0]),this.do_session?(this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2"),this.send(b({type:"set",id:"_session_auth_2"}).c("session",{xmlns:f.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(f.Status.CONNECTED,null)));else return f.info("SASL binding failed."),this._changeConnectStatus(f.Status.AUTHFAIL,null),!1},_sasl_session_cb:function(a){"result"==a.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(f.Status.CONNECTED,null)):"error"==a.getAttribute("type")&&(f.info("Session creation failed."),this._changeConnectStatus(f.Status.AUTHFAIL,null));return!1},_sasl_failure_cb:function(a){this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null);this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);this._changeConnectStatus(f.Status.AUTHFAIL,null);return!1},_auth2_cb:function(a){"result"==a.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(f.Status.CONNECTED,null)):"error"==a.getAttribute("type")&&(this._changeConnectStatus(f.Status.AUTHFAIL,null),this.disconnect());return!1},_addSysTimedHandler:function(a,b){var c=new f.TimedHandler(a,b);c.user=!1;this.addTimeds.push(c);return c},_addSysHandler:function(a,b,c,d,e){a=new f.Handler(a,b,c,d,e);a.user=!1;this.addHandlers.push(a);return a},_onDisconnectTimeout:function(){f.info("_onDisconnectTimeout was called");for(var a;0<this._requests.length;)a=this._requests.pop(),a.abort=!0,a.xhr.abort(),a.xhr.onreadystatechange=function(){};this._doDisconnect();return!1},_onIdle:function(){for(var a,b,c,d;0<this.addTimeds.length;)this.timedHandlers.push(this.addTimeds.pop());for(;0<this.removeTimeds.length;)b=this.removeTimeds.pop(),a=this.timedHandlers.indexOf(b),0<=a&&this.timedHandlers.splice(a,1);var e=(new Date).getTime();d=[];for(a=0;a<this.timedHandlers.length;a++)if(b=this.timedHandlers[a],this.authenticated||!b.user)c=b.lastCalled+b.period,0>=c-e?b.run()&&d.push(b):d.push(b);this.timedHandlers=d;this.authenticated&&0===this._requests.length&&(0===this._data.length&&!this.disconnecting)&&(f.info("no requests during idle cycle, sending blank request"),this._data.push(null));if(2>this._requests.length&&0<this._data.length&&!this.paused){b=this._buildBody();for(a=0;a<this._data.length;a++)null!==this._data[a]&&("restart"===this._data[a]?b.attrs({to:this.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":f.NS.BOSH}):b.cnode(this._data[a]).up());delete this._data;this._data=[];this._requests.push(new f.Request(b.tree(),this._onRequestStateChange.bind(this,this._dataRecv.bind(this)),b.tree().getAttribute("rid")));this._processRequest(this._requests.length-1)}0<this._requests.length&&(a=this._requests[0].age(),null!==this._requests[0].dead&&this._requests[0].timeDead()>Math.floor(f.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),a>Math.floor(f.TIMEOUT*this.wait)&&(f.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(f.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler()));clearTimeout(this._idleTimeout);this.connected&&(this._idleTimeout=setTimeout(this._onIdle.bind(this),100))}};d&&d(f,a,c,b,e)})(function(d,a,c,b,e){window.Strophe=d;window.$build=a;window.$msg=c;window.$iq=b;window.$pres=e});var Occupant,RoomConfig,XmppRoom,__bind=function(d,a){return function(){return d.apply(a,arguments)}};Strophe.addConnectionPlugin("muc",{_connection:null,rooms:[],init:function(d){this._connection=d;this._muc_handler=null;Strophe.addNamespace("MUC_OWNER",Strophe.NS.MUC+"#owner");Strophe.addNamespace("MUC_ADMIN",Strophe.NS.MUC+"#admin");Strophe.addNamespace("MUC_USER",Strophe.NS.MUC+"#user");return Strophe.addNamespace("MUC_ROOMCONF",Strophe.NS.MUC+"#roomconfig")},join:function(d,a,c,b,e,f){var g,l,n=this;g=this.test_append_nick(d,a);g=$pres({from:this._connection.jid,to:g}).c("x",{xmlns:Strophe.NS.MUC});null!=f&&g.cnode(Strophe.xmlElement("password",[],f));null==this._muc_handler&&(this._muc_handler=this._connection.addHandler(function(a){var b,c,e,f,g,h;b=a.getAttribute("from");if(!b)return!0;b=b.split("/")[0];if(!n.rooms[b])return!0;d=n.rooms[b];b={};if("message"===a.nodeName)b=d._message_handlers;else if("presence"===a.nodeName&&(c=a.getElementsByTagName("x"),0<c.length)){g=0;for(h=c.length;g<h;g++)if(f=c[g],(f=f.getAttribute("xmlns"))&&f.match(Strophe.NS.MUC)){b=d._presence_handlers;break}}for(e in b)c=b[e],c(a,d)||delete b[e];return!0}));if(null==(l=this.rooms)[d])l[d]=new XmppRoom(this,d,a,f);b&&this.rooms[d].addHandler("presence",b);c&&this.rooms[d].addHandler("message",c);e&&this.rooms[d].addHandler("roster",e);return this._connection.send(g)},leave:function(d,a,c,b){delete this.rooms[d];0===this.rooms.length&&(this._connection.deleteHandler(this._muc_handler),this._muc_handler=null);a=this.test_append_nick(d,a);d=this._connection.getUniqueId();a=$pres({type:"unavailable",id:d,from:this._connection.jid,to:a});null!=b&&a.c("status",b);null!=c&&this._connection.addHandler(c,null,"presence",null,d);this._connection.send(a);return d},message:function(d,a,c,b,e){d=this.test_append_nick(d,a);e=e||(null!=a?"chat":"groupchat");a=this._connection.getUniqueId();c=$msg({to:d,from:this._connection.jid,type:e,id:a}).c("body",{xmlns:Strophe.NS.CLIENT}).t(c);c.up();null!=b&&(c.c("html",{xmlns:Strophe.NS.XHTML_IM}).c("body",{xmlns:Strophe.NS.XHTML}).h(b),0===c.node.childNodes.length?(b=c.node.parentNode,c.up().up(),c.node.removeChild(b)):c.up().up());c.c("x",{xmlns:"jabber:x:event"}).c("composing");this._connection.send(c);return a},groupchat:function(d,a,c){return this.message(d,null,a,c)},invite:function(d,a,c){var b;b=this._connection.getUniqueId();d=$msg({from:this._connection.jid,to:d,id:b}).c("x",{xmlns:Strophe.NS.MUC_USER}).c("invite",{to:a});null!=c&&d.c("reason",c);this._connection.send(d);return b},directInvite:function(d,a,c,b){var e;e=this._connection.getUniqueId();d={xmlns:"jabber:x:conference",jid:d};null!=c&&(d.reason=c);null!=b&&(d.password=b);a=$msg({from:this._connection.jid,to:a,id:e}).c("x",d);this._connection.send(a);return e},queryOccupants:function(d,a,c){var b;b={xmlns:Strophe.NS.DISCO_ITEMS};d=$iq({from:this._connection.jid,to:d,type:"get"}).c("query",b);return this._connection.sendIQ(d,a,c)},configure:function(d,a,c){d=$iq({to:d,type:"get"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).tree();return this._connection.sendIQ(d,a,c)},cancelConfigure:function(d){d=$iq({to:d,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"cancel"}).tree();return this._connection.sendIQ(d)},saveConfiguration:function(d,a,c,b){var e,f,g;e=$iq({to:d,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER});if(a instanceof Form)a.type="submit",e.cnode(a.toXML());else{e.c("x",{xmlns:"jabber:x:data",type:"submit"});f=0;for(g=a.length;f<g;f++)d=a[f],e.cnode(d).up()}a=e.tree();return this._connection.sendIQ(a,c,b)},createInstantRoom:function(d,a,c){d=$iq({to:d,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"});return this._connection.sendIQ(d.tree(),a,c)},setTopic:function(d,a){var c;c=$msg({to:d,from:this._connection.jid,type:"groupchat"}).c("subject",{xmlns:"jabber:client"}).t(a);return this._connection.send(c.tree())},_modifyPrivilege:function(d,a,c,b,e){d=$iq({to:d,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_ADMIN}).cnode(a.node);null!=c&&d.c("reason",c);return this._connection.sendIQ(d.tree(),b,e)},modifyRole:function(d,a,c,b,e,f){a=$build("item",{nick:a,role:c});return this._modifyPrivilege(d,a,b,e,f)},kick:function(d,a,c,b,e){return this.modifyRole(d,a,"none",c,b,e)},voice:function(d,a,c,b,e){return this.modifyRole(d,a,"participant",c,b,e)},mute:function(d,a,c,b,e){return this.modifyRole(d,a,"visitor",c,b,e)},op:function(d,a,c,b,e){return this.modifyRole(d,a,"moderator",c,b,e)},deop:function(d,a,c,b,e){return this.modifyRole(d,a,"participant",c,b,e)},modifyAffiliation:function(d,a,c,b,e,f){a=$build("item",{jid:a,affiliation:c});return this._modifyPrivilege(d,a,b,e,f)},ban:function(d,a,c,b,e){return this.modifyAffiliation(d,a,"outcast",c,b,e)},member:function(d,a,c,b,e){return this.modifyAffiliation(d,a,"member",c,b,e)},revoke:function(d,a,c,b,e){return this.modifyAffiliation(d,a,"none",c,b,e)},owner:function(d,a,c,b,e){return this.modifyAffiliation(d,a,"owner",c,b,e)},admin:function(d,a,c,b,e){return this.modifyAffiliation(d,a,"admin",c,b,e)},changeNick:function(d,a){var c;c=this.test_append_nick(d,a);c=$pres({from:this._connection.jid,to:c,id:this._connection.getUniqueId()});return this._connection.send(c.tree())},setStatus:function(d,a,c,b){d=this.test_append_nick(d,a);d=$pres({from:this._connection.jid,to:d});null!=c&&d.c("show",c).up();null!=b&&d.c("status",b);return this._connection.send(d.tree())},listRooms:function(d,a,c){d=$iq({to:d,from:this._connection.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS});return this._connection.sendIQ(d,a,c)},test_append_nick:function(d,a){return d+(null!=a?"/"+Strophe.escapeNode(a):"")}});XmppRoom=function(){function d(a,c,b,d){this.client=a;this.name=c;this.nick=b;this.password=d;this._roomRosterHandler=__bind(this._roomRosterHandler,this);this._addOccupant=__bind(this._addOccupant,this);a.muc&&(this.client=a.muc);this.name=Strophe.getBareJidFromJid(c);this.client.rooms[this.name]=this;this.addHandler("presence",this._roomRosterHandler)}d.prototype.roster={};d.prototype._message_handlers={};d.prototype._presence_handlers={};d.prototype._roster_handlers={};d.prototype._handler_ids=0;d.prototype.join=function(a,c,b){return this.client.join(this.name,this.nick,a,c,b,this.password)};d.prototype.leave=function(a,c){this.client.leave(this.name,this.nick,a,c);return delete this.client.rooms[this.name]};d.prototype.message=function(a,c,b,d){return this.client.message(this.name,a,c,b,d)};d.prototype.groupchat=function(a,c){return this.client.groupchat(this.name,a,c)};d.prototype.invite=function(a,c){return this.client.invite(this.name,a,c)};d.prototype.directInvite=function(a,c){return this.client.directInvite(this.name,a,c,this.password)};d.prototype.configure=function(a){return this.client.configure(this.name,a)};d.prototype.cancelConfigure=function(){return this.client.cancelConfigure(this.name)};d.prototype.saveConfiguration=function(a){return this.client.saveConfiguration(this.name,a)};d.prototype.queryOccupants=function(a,c){return this.client.queryOccupants(this.name,a,c)};d.prototype.setTopic=function(a){return this.client.setTopic(this.name,a)};d.prototype.modifyRole=function(a,c,b,d,f){return this.client.modifyRole(this.name,a,c,b,d,f)};d.prototype.kick=function(a,c,b,d){return this.client.kick(this.name,a,c,b,d)};d.prototype.voice=function(a,c,b,d){return this.client.voice(this.name,a,c,b,d)};d.prototype.mute=function(a,c,b,d){return this.client.mute(this.name,a,c,b,d)};d.prototype.op=function(a,c,b,d){return this.client.op(this.name,a,c,b,d)};d.prototype.deop=function(a,c,b,d){return this.client.deop(this.name,a,c,b,d)};d.prototype.modifyAffiliation=function(a,c,b,d,f){return this.client.modifyAffiliation(this.name,a,c,b,d,f)};d.prototype.ban=function(a,c,b,d){return this.client.ban(this.name,a,c,b,d)};d.prototype.member=function(a,c,b,d){return this.client.member(this.name,a,c,b,d)};d.prototype.revoke=function(a,c,b,d){return this.client.revoke(this.name,a,c,b,d)};d.prototype.owner=function(a,c,b,d){return this.client.owner(this.name,a,c,b,d)};d.prototype.admin=function(a,c,b,d){return this.client.admin(this.name,a,c,b,d)};d.prototype.changeNick=function(a){this.nick=a;return this.client.changeNick(this.name,a)};d.prototype.setStatus=function(a,c){return this.client.setStatus(this.name,this.nick,a,c)};d.prototype.addHandler=function(a,c){var b;b=this._handler_ids++;switch(a){case"presence":this._presence_handlers[b]=c;break;case"message":this._message_handlers[b]=c;break;case"roster":this._roster_handlers[b]=c;break;default:return this._handler_ids--,null}return b};d.prototype.removeHandler=function(a){delete this._presence_handlers[a];delete this._message_handlers[a];return delete this._roster_handlers[a]};d.prototype._addOccupant=function(a){a=new Occupant(a,this);return this.roster[a.nick]=a};d.prototype._roomRosterHandler=function(a){var c,b,e;a=d._parsePresence(a);e=a.nick;b=a.newnick||null;switch(a.type){case"error":return;case"unavailable":b&&(a.nick=b,this.roster.hasOwnProperty(e)&&this.roster.hasOwnProperty(b)&&(this.roster[e].update(this.roster[b]),this.roster[b]=this.roster[e]),this.roster.hasOwnProperty(e)&&!this.roster.hasOwnProperty(b)&&(this.roster[b]=this.roster[e].update(a)));delete this.roster[e];break;default:this.roster.hasOwnProperty(e)?this.roster[e].update(a):this._addOccupant(a)}b=this._roster_handlers;for(c in b)a=b[c],a(this.roster,this)||delete this._roster_handlers[c];return!0};d._parsePresence=function(a){var c,b,d,f,g,l,n,s,r,q,p,t;d={};c=a.attributes;d.nick=Strophe.getResourceFromJid(c.from.textContent);d.type=(null!=(f=c.type)?f.textContent:void 0)||null;d.states=[];l=a.childNodes;a=0;for(f=l.length;a<f;a++)switch(b=l[a],b.nodeName){case"status":d.status=b.textContent||null;break;case"show":d.show=b.textContent||null;break;case"x":if(c=b.attributes,(null!=(n=c.xmlns)?n.textContent:void 0)===Strophe.NS.MUC_USER){s=b.childNodes;b=0;for(g=s.length;b<g;b++)switch(c=s[b],c.nodeName){case"item":c=c.attributes;d.affiliation=(null!=(r=c.affiliation)?r.textContent:void 0)||null;d.role=(null!=(q=c.role)?q.textContent:void 0)||null;d.jid=(null!=(p=c.jid)?p.textContent:void 0)||null;d.newnick=(null!=(t=c.nick)?t.textContent:void 0)||null;break;case"status":c.attributes.code&&d.states.push(c.attributes.code.textContent)}}}return d};return d}();RoomConfig=function(){function d(a){this.parse=__bind(this.parse,this);null!=a&&this.parse(a)}d.prototype.parse=function(a){var c,b,d,f,g,l,n;d=a.getElementsByTagName("query")[0].childNodes;this.identities=[];this.features=[];this.x=[];f=0;for(l=d.length;f<l;f++)switch(c=d[f],a=c.attributes,c.nodeName){case"identity":b={};g=0;for(n=a.length;g<n;g++)c=a[g],b[c.name]=c.textContent;this.identities.push(b);break;case"feature":this.features.push(a["var"].textContent);break;case"x":a=c.childNodes[0].attributes;if("FORM_TYPE"===!a["var"].textContent||"hidden"===!a.type.textContent)break;n=c.childNodes;b=0;for(g=n.length;b<g;b++)c=n[b],c.attributes.type||(a=c.attributes,this.x.push({"var":a["var"].textContent,label:a.label.textContent||"",value:c.firstChild.textContent||""}))}return{identities:this.identities,features:this.features,x:this.x}};return d}();Occupant=function(){function d(a,c){this.room=c;this.update=__bind(this.update,this);this.admin=__bind(this.admin,this);this.owner=__bind(this.owner,this);this.revoke=__bind(this.revoke,this);this.member=__bind(this.member,this);this.ban=__bind(this.ban,this);this.modifyAffiliation=__bind(this.modifyAffiliation,this);this.deop=__bind(this.deop,this);this.op=__bind(this.op,this);this.mute=__bind(this.mute,this);this.voice=__bind(this.voice,this);this.kick=__bind(this.kick,this);this.modifyRole=__bind(this.modifyRole,this);this.update(a)}d.prototype.modifyRole=function(a,c,b,d){return this.room.modifyRole(this.nick,a,c,b,d)};d.prototype.kick=function(a,c,b){return this.room.kick(this.nick,a,c,b)};d.prototype.voice=function(a,c,b){return this.room.voice(this.nick,a,c,b)};d.prototype.mute=function(a,c,b){return this.room.mute(this.nick,a,c,b)};d.prototype.op=function(a,c,b){return this.room.op(this.nick,a,c,b)};d.prototype.deop=function(a,c,b){return this.room.deop(this.nick,a,c,b)};d.prototype.modifyAffiliation=function(a,c,b,d){return this.room.modifyAffiliation(this.jid,a,c,b,d)};d.prototype.ban=function(a,c,b){return this.room.ban(this.jid,a,c,b)};d.prototype.member=function(a,c,b){return this.room.member(this.jid,a,c,b)};d.prototype.revoke=function(a,c,b){return this.room.revoke(this.jid,a,c,b)};d.prototype.owner=function(a,c,b){return this.room.owner(this.jid,a,c,b)};d.prototype.admin=function(a,c,b){return this.room.admin(this.jid,a,c,b)};d.prototype.update=function(a){this.nick=a.nick||null;this.affiliation=a.affiliation||null;this.role=a.role||null;this.jid=a.jid||null;this.status=a.status||null;this.show=a.show||null;return this};return d}();Strophe.addConnectionPlugin("register",{_connection:null,init:function(d){this._connection=d;var a=0;Object.keys(Strophe.Status).forEach(function(b){a=Math.max(a,Strophe.Status[b])});Strophe.addNamespace("REGISTER","jabber:iq:register");Strophe.Status.REGISTERING=a+1;Strophe.Status.REGIFAIL=a+2;Strophe.Status.REGISTER=a+3;Strophe.Status.SUBMITTING=a+4;Strophe.Status.SBMTFAIL=a+5;Strophe.Status.REGISTERED=a+6;d.disco&&d.disco.addFeature(Strophe.NS.REGISTER);var c=this,b=d.reset;d.reset=function(){b();c.instructions="";c.fields={};c.authentication={};c.registered=!1;c.enabled=null}},connect:function(d,a,c,b){var e=this._connection;this.instructions="";this.fields={};this.authentication={};this.enabled=this.registered=!1;e.connect_callback=a;e.connected=!1;e.authenticated=!1;e.disconnecting=!1;e.errors=0;e.domain=d||e.domain;e.wait=c||e.wait;e.hold=b||e.hold;d=e._buildBody().attrs({to:e.domain,"xml:lang":"en",wait:e.wait,hold:e.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":Strophe.NS.BOSH});e._changeConnectStatus(Strophe.Status.CONNECTING,null);e._requests.push(new Strophe.Request(d.tree(),e._onRequestStateChange.bind(e,this._register_cb.bind(this)),d.tree().getAttribute("rid")));e._throttledRequestHandler()},_register_cb:function(d){var a=this._connection;Strophe.info("_register_cb was called");a.connected=!0;if(d=d.getResponse()){a.xmlInput!==Strophe.Connection.prototype.xmlInput&&a.xmlInput(d);a.rawInput!==Strophe.Connection.prototype.rawInput&&a.rawInput(Strophe.serialize(d));var c=d.getAttribute("type");if(null!==c&&"terminate"==c)c=d.getAttribute("condition"),d=d.getElementsByTagName("conflict"),null!==c?("remote-stream-error"==c&&0<d.length&&(c="conflict"),a._changeConnectStatus(Strophe.Status.CONNFAIL,c)):a._changeConnectStatus(Strophe.Status.CONNFAIL,"unknown");else{a.sid||(a.sid=d.getAttribute("sid"));a.stream_id||(a.stream_id=d.getAttribute("authid"));if(c=d.getAttribute("requests"))a.window=parseInt(c,10);if(c=d.getAttribute("hold"))a.hold=parseInt(c,10);if(c=d.getAttribute("wait"))a.wait=parseInt(c,10);c=d.getElementsByTagName("register");d=d.getElementsByTagName("mechanism");if(0===c.length&&0===d.length)d=a._buildBody(),a._requests.push(new Strophe.Request(d.tree(),a._onRequestStateChange.bind(a,this._register_cb.bind(this)),d.tree().getAttribute("rid"))),a._throttledRequestHandler();else{var b,e;for(b=0;b<d.length;b++)e=Strophe.getText(d[b]),"DIGEST-MD5"==e?this.authentication.sasl_digest_md5=!0:"PLAIN"==e?this.authentication.sasl_plain=!0:"ANONYMOUS"==e&&(this.authentication.sasl_anonymous=!0);0===c.length?a._changeConnectStatus(Strophe.Status.REGIFAIL,null):(this.enabled=!0,a._changeConnectStatus(Strophe.Status.REGISTERING,null),a._addSysHandler(this._get_register_cb.bind(this),null,"iq",null,null),a.send($iq({type:"get"}).c("query",{xmlns:Strophe.NS.REGISTER}).tree()))}}}},_get_register_cb:function(d){var a,c,b=this._connection;a=d.getElementsByTagName("query");if(1!==a.length)return b._changeConnectStatus(Strophe.Status.REGIFAIL,"unknown"),!1;a=a[0];for(d=0;d<a.childNodes.length;d++)c=a.childNodes[d],"instructions"===c.tagName.toLowerCase()?this.instructions=Strophe.getText(c):"x"!==c.tagName.toLowerCase()&&(this.fields[c.tagName.toLowerCase()]=Strophe.getText(c));b._changeConnectStatus(Strophe.Status.REGISTER,null);return!1},submit:function(){var d,a,c,b,e=this._connection;c=$iq({type:"set"}).c("query",{xmlns:Strophe.NS.REGISTER});b=Object.keys(this.fields);for(d=0;d<b.length;d++)a=b[d],c.c(a).t(this.fields[a]).up();e._changeConnectStatus(Strophe.Status.SUBMITTING,null);e._addSysHandler(this._submit_cb.bind(this),null,"iq",null,null);e.send(c)},_submit_cb:function(d){var a,c,b,e=null,f=this._connection;c=d.getElementsByTagName("query");if(0<c.length){c=c[0];for(a=0;a<c.childNodes.length;a++)b=c.childNodes[a],"instructions"===b.tagName.toLowerCase()?this.instructions=Strophe.getText(b):this.fields[b.tagName.toLowerCase()]=Strophe.getText(b)}if("error"===d.getAttribute("type")){e=d.getElementsByTagName("error");if(1!==e.length)return f._changeConnectStatus(Strophe.Status.SBMTFAIL,"unknown"),!1;e=e[0].firstChild.tagName.toLowerCase();"conflict"===e&&(this.registered=!0)}else this.registered=!0;this.registered&&(f.jid=this.fields.username+"@"+f.domain,f.pass=this.fields.password);null===e?(Strophe.info("Registered successful."),f._changeConnectStatus(Strophe.Status.REGISTERED,null)):(Strophe.info("Registration failed."),f._changeConnectStatus(Strophe.Status.SBMTFAIL,e));return!1},authenticate:function(){var d,a=this._connection;null===Strophe.getNodeFromJid(a.jid)&&this.authentication.sasl_anonymous?(a._changeConnectStatus(Strophe.Status.AUTHENTICATING,null),a._sasl_success_handler=a._addSysHandler(a._sasl_success_cb.bind(a),null,"success",null,null),a._sasl_failure_handler=a._addSysHandler(a._sasl_failure_cb.bind(a),null,"failure",null,null),a.send($build("auth",{xmlns:Strophe.NS.SASL,mechanism:"ANONYMOUS"}).tree())):null===Strophe.getNodeFromJid(a.jid)?(a._changeConnectStatus(Strophe.Status.CONNFAIL,"x-strophe-bad-non-anon-jid"),a.disconnect()):this.authentication.sasl_digest_md5?(a._changeConnectStatus(Strophe.Status.AUTHENTICATING,null),a._sasl_challenge_handler=a._addSysHandler(a._sasl_challenge1_cb.bind(a),null,"challenge",null,null),a._sasl_failure_handler=a._addSysHandler(a._sasl_failure_cb.bind(a),null,"failure",null,null),a.send($build("auth",{xmlns:Strophe.NS.SASL,mechanism:"DIGEST-MD5"}).tree())):this.authentication.sasl_plain?(d=Strophe.getBareJidFromJid(a.jid),d=d+"\x00"+Strophe.getNodeFromJid(a.jid),d+="\x00",d+=a.pass,a._changeConnectStatus(Strophe.Status.AUTHENTICATING,null),a._sasl_success_handler=a._addSysHandler(a._sasl_success_cb.bind(a),null,"success",null,null),a._sasl_failure_handler=a._addSysHandler(a._sasl_failure_cb.bind(a),null,"failure",null,null),d=Base64.encode(d),a.send($build("auth",{xmlns:Strophe.NS.SASL,mechanism:"PLAIN"}).t(d).tree())):(a._changeConnectStatus(Strophe.Status.AUTHENTICATING,null),a._addSysHandler(a._auth1_cb.bind(a),null,null,null,"_auth_1"),a.send($iq({type:"get",to:a.domain,id:"_auth_1"}).c("query",{xmlns:Strophe.NS.AUTH}).c("username",{}).t(Strophe.getNodeFromJid(a.jid)).tree()))}});